<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs
			title="__MSG_nagios-gadget.title__"
			author="dfabac"
			author_email="dfabac@gmail.com"
			description="__MSG_nagios-gadget.description__"
			thumbnail='#staticResourceUrl("com.rtve.pluginsjira.nagios-glance-gadget:nagios-glance-gadget-resources", "gadget-thumb.png")'>
		<Optional feature="gadget-directory">
			<Param name="categories">Other</Param>
		</Optional>
		<Optional feature="atlassian.util" />
		<Require feature="dynamic-height" />
		<Require feature="settitle" />
		<Require feature="oauthpopup" />
		<Require feature="views" />
		<Require feature="setprefs" />
		#oauth
		#supportedLocales("gadget.common")
		<Locale messages='#staticResourceUrl("com.rtve.pluginsjira.nagios-glance-gadget:nagios-glance-gadget-resources", "i18n/ALL_ALL.xml")' />
		<Locale lang="es" messages='#staticResourceUrl("com.rtve.pluginsjira.nagios-glance-gadget:nagios-glance-gadget-resources", "i18n/es_ALL.xml")' />
	</ModulePrefs>

	<UserPref name="isConfigured" datatype="hidden" default_value="false" />
	<UserPref name="refresh" datatype="hidden" default_value="false" />
	<UserPref name="problemsURL" datatype="hidden" default_value="http://monitoriza.irtve.rtve.int/wsnagios/problems" />

	<Content type="html"><![CDATA[
		#requireResource("com.atlassian.gadgets.publisher:ajs-gadgets")
		#includeResources()

		<style TYPE="text/css">

			span { 
				margin-left : 5px; 
			}
			table {
				width   : 100%;
				padding : 2px;
			}
			tr.critical {
				border-right  : 1px solid #FB7A31;
				border-bottom : 1px solid #FB7A31;
				background    : #ff9b9b;
			}
			tr.warning  {
				border-right  : 1px solid #ffff00;
				border-bottom : 1px solid #ffff00;
				background    : #ffff80;
			}
		</style>

		<script type="text/javascript">
			(function () {
                var gadget = AJS.Gadget({
                    baseUrl: "__ATLASSIAN_BASE_URL__",
                    useOauth: "/rest/gadget/1.0/currentUser",
					config: {
                        descriptor: function (args) {
							return {
                                fields: [
									{
										userpref: 'problemsURL',
										label: 'problems URL:',
										description: 'URL de WSNagios problems',
										type: 'text',
										value: this.getPref('problemsURL')
									},
									AJS.gadget.fields.nowConfigured()
								]
                            };
                        },
                        args: []
                    },
                    view: {
						enableReload: true,
                        template: function(args) {

                            var projectList = AJS.$("<table/>");

							function populate(data, stylename, container) {
								 AJS.$(data).each(function() {
									container.append(
										AJS.$("<tr/>").append(
											AJS.$("<td/>").append(
												this.last_check
											),
											AJS.$("<td/>").append(
												AJS.$("<a/>").attr({
													target: "_parent",
													href: "__ATLASSIAN_BASE_URL__"
												}).text(this.host)
											),
											AJS.$("<td/>").append(  
												AJS.$("<a/>").attr({
													target: "_parent",
													title: gadgets.util.escapeString(this.status_info),
													href: "__ATLASSIAN_BASE_URL__"
												}).text(this.service)
											)
										).attr(
											{ class : stylename }
										)
									);
								});
							}

							populate(args.dataProblems.problems.critical.items, 'critical', projectList);
							populate(args.dataProblems.problems.warning.items,  'warning',  projectList);

							summary = AJS.$("<div/>").append(
								AJS.$("<span/>").append(
									"c: " + args.dataProblems.problems.critical.total
								),
								AJS.$("<span/>").append(
									"w: " + args.dataProblems.problems.warning.total
								)

							);

                            gadget.getView().append(projectList, summary);
                        },
                        args: [{
                            key: "dataProblems",
                            ajaxOptions: function() {
                                return {
                                    url: this.getPref('problemsURL')
                                };
                            }
                        }]
                    }
                });
            })();
		</script>

	]]></Content>
</Module>
